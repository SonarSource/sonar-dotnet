schedules:
# Run from Monday to Friday at 5:30 UTC (https://docs.microsoft.com/en-us/azure/devops/pipelines/process/scheduled-triggers?view=azure-devops&tabs=yaml#cron-syntax)
- cron: "30 5 * * 1-5"
  displayName: Daily build
  branches:
    include:
    - master
    - branch-*
  always: true

trigger:
- master
- branch-*

pool: .net-bubble-aws-re-team-prod

variables:
  - group: sonar-dotnet-variables
  - group: sonarsource-build-variables
  - group: artifactory_access
  # ~https://github.com/SonarSource/re-ci-images/blob/master/docker/mvn/settings-private.xml
  - name: ARTIFACTORY_PRIVATE_USERNAME
    value: $[variables.ARTIFACTORY_PRIVATE_READER_USERNAME]
  - name: ARTIFACTORY_QA_READER_USERNAME
    value: $[variables.ARTIFACTORY_PRIVATE_READER_USERNAME]
  - name: UnitTestProjectPath
    value: 'analyzers\tests\SonarAnalyzer.Test\'
  - name: UnitTestResultsPath
    value: '$(Build.SourcesDirectory)\TestResults'
  - name: CoveragePath
    value: '$(Build.SourcesDirectory)\coverage'
  - name: UnitTestExclusionsPattern
    value: 'analyzers/tests/SonarAnalyzer.Test/TestCases/**/*'
  - name: vsVersion
    value: '17.0'

resources:
  repositories:
    - repository: pipelines-yaml-templates
      type: git
      name: pipelines-yaml-templates
      ref:  refs/tags/v3.0.0

stages:
- stage: build
  displayName: 'Build:'
  jobs:
  - job: dotnetBuildjob
    displayName: 'Build and package'
    workspace:
      clean: all

    steps:
    - task: NuGetToolInstaller@1
      displayName: "Install NuGet"

    - script: '"$(MSBUILD_PATH)" /t:restore /p:RestoreLockedMode=true /p:RestoreConfigFile="analyzers\NuGet.Config" $(solution)'
      env:
        ARTIFACTORY_USER: $(ARTIFACTORY_PRIVATE_READER_USERNAME)
        ARTIFACTORY_PASSWORD: $(ARTIFACTORY_PRIVATE_READER_ACCESS_TOKEN)
      displayName: "NuGet Restore"

    - powershell: .\scripts\build\store-azp-variables.ps1
      displayName: "Store AZP Variables"

    - publish: $(Agent.BuildDirectory)/Azp-Variables
      artifact: Azp-Variables
      displayName: "Publish AZP Variables as pipeline artifact"

    - template: set-azp-variables-steps.yml@pipelines-yaml-templates

    - powershell: .\scripts\set-version.ps1 -Version $(SHORT_VERSION) -BuildNumber $(Build.BuildId) -Branch $(Build.SourceBranchName) -Sha1 $(Build.SourceVersion)
      displayName: "Set Version"

    - task: VSBuild@1
      displayName: "Build SonarAnalyzer solution"
      inputs:
        solution: '$(solution)'
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'
        msbuildArgs: '/p:WarningLevel=0'
        vsVersion: $(vsVersion)

    - task: NuGetCommand@2
      displayName: "Build NuGet packages"
      inputs:
        command: pack
        packagesToPack: 'analyzers/packaging/*.nuspec'
        configuration: '$(BuildConfiguration)'
        buildProperties: 'Version=$(FULL_VERSION)'
        packDestination: '$(Build.ArtifactStagingDirectory)/packages'
        verbosityPack: 'Detailed'
        publishPackageMetadata: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish NuGet packages as build artifacts'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/packages'
        artifactName: 'NuGet Packages'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish analyzer binaries as pipeline artifact'
      inputs:
        path: analyzers/packaging/binaries/
        artifact: Binaries

    - task: PublishPipelineArtifact@1
      displayName: 'Publish analyzer test binaries as pipeline artifact'
      inputs:
        path: '$(UnitTestProjectPath)\bin'
        artifact: TestBinaries

- stage: qa
  # .NET code analysis, UTs, ITs, build Java and publish SC QG
  displayName: 'Tests:'
  dependsOn: build

  jobs:
  - job: runUnitTestsDotNet
    displayName: '.NET UTs'
    workspace:
      clean: all
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download binaries to test'
      inputs:
        artifact: TestBinaries
        targetPath: '$(UnitTestProjectPath)\bin'

    - powershell: |
        $ProjectNameToken = '$(ProjectName)'  # Workaround for escaping difficulties: Azure DevOps doesn't have ProjectName, so it will not replace it. We need to pass it like that into AltCover via powershell.
        dotnet test $(Solution) -c $(BuildConfiguration) -l trx --results-directory $(UnitTestResultsPath) /p:AltCover=true,AltCoverForce=true,AltCoverVisibleBranches=true,AltCoverAssemblyFilter="testhost|Moq|Humanizer|AltCover|Microsoft|\.Test^",AltCoverPathFilter="SonarAnalyzer\.CFG\\ShimLayer|SonarAnalyzer\.ShimLayer\.CodeGeneration",AltCoverAttributeFilter="ExcludeFromCodeCoverage",AltCoverReport="$(CoveragePath)/coverage.$ProjectNameToken.xml"
      displayName: '.Net UTs'
      env:
        ARTIFACTORY_USER: $(ARTIFACTORY_PRIVATE_READER_USERNAME)
        ARTIFACTORY_PASSWORD: $(ARTIFACTORY_PRIVATE_READER_ACCESS_TOKEN)

    - task: PublishPipelineArtifact@1
      displayName: 'Save coverage file'
      inputs:
        path: '$(CoveragePath)'
        artifact: DotNetCoverage

    - task: PublishPipelineArtifact@1
      displayName: 'Save test results files'
      inputs:
        path: '$(UnitTestResultsPath)'
        artifact: DotNetTestResults

    - task: PublishTestResults@2
      condition: always()
      displayName: 'Publish test results'
      inputs:
        testRunner: VSTest
        testResultsFiles: '*.trx'
        searchFolder: '$(UnitTestResultsPath)'
        testRunTitle: '$(Agent.JobName)'

  - job: dotNetAnalysis
    displayName: '.Net Analysis'
    workspace:
      clean: all
    # This job runs the .Net code analysis and uploads to SonarCloud the test results and coverage reports generated
    # in previous jobs.
    condition: eq(dependencies.runUnitTestsDotNet.result, 'Succeeded')
    dependsOn:
    - runUnitTestsDotNet
    steps:
    - task: NuGetToolInstaller@1
      displayName: "Install NuGet"

    - template: set-azp-variables-steps.yml@pipelines-yaml-templates

    - task: SonarCloudPrepare@2
      displayName: 'Code Analysis - Begin (PR)'
      condition: eq(variables['Build.Reason'], 'PullRequest')
      inputs:
        SonarCloud: 'SonarCloud'
        organization: 'sonarsource'
        scannerMode: 'MSBuild'
        projectKey: 'sonaranalyzer-dotnet'
        projectName: 'Sonar .NET Analyzer'
        projectVersion: '$(SHORT_VERSION)'
        extraProperties: |
          sonar.verbose=true
          sonar.cs.opencover.reportsPaths="$(CoveragePath)/*.xml"
          sonar.cs.vstest.reportsPaths="$(UnitTestResultsPath)/*.trx"
          sonar.test.exclusions="$(UnitTestExclusionsPattern)"
          sonar.analysis.buildNumber=$(Build.BuildId)
          sonar.analysis.pipeline=$(Build.BuildId)
          sonar.analysis.sha1=$(System.PullRequest.SourceCommitId)
          sonar.analysis.prNumber=$(System.PullRequest.PullRequestNumber)
          sonar.analysis.repository=$(Build.Repository.ID)

    - task: SonarCloudPrepare@2
      displayName: 'Code Analysis - Begin (master or branch)'
      condition: ne(variables['Build.Reason'], 'PullRequest')
      inputs:
        SonarCloud: 'SonarCloud'
        organization: 'sonarsource'
        scannerMode: 'MSBuild'
        projectKey: 'sonaranalyzer-dotnet'
        projectName: 'Sonar .NET Analyzer'
        projectVersion: '$(SHORT_VERSION)'
        extraProperties: |
          sonar.verbose=true
          sonar.cs.opencover.reportsPaths="$(CoveragePath)/*.xml"
          sonar.cs.vstest.reportsPaths="$(UnitTestResultsPath)/*.trx"
          sonar.test.exclusions="$(UnitTestExclusionsPattern)"
          sonar.analysis.buildNumber=$(Build.BuildId)
          sonar.analysis.pipeline=$(Build.BuildId)
          sonar.analysis.sha1=$(Build.SourceVersion)
          sonar.analysis.repository=$(Build.Repository.ID)

    - powershell: .\scripts\set-version.ps1 -Version $(SHORT_VERSION) -BuildNumber $(Build.BuildId) -Branch $(Build.SourceBranchName) -Sha1 $(Build.SourceVersion)
      displayName: "Set Version"

    - script: '"$(MSBUILD_PATH)" /t:restore /p:RestoreLockedMode=true /p:RestoreConfigFile="analyzers\NuGet.Config" $(solution)'
      env:
        ARTIFACTORY_USER: $(ARTIFACTORY_PRIVATE_READER_USERNAME)
        ARTIFACTORY_PASSWORD: $(ARTIFACTORY_PRIVATE_READER_ACCESS_TOKEN)
      displayName: "NuGet Restore"

    - task: VSBuild@1
      displayName: "Run .Net code analysis"
      inputs:
        solution: '$(solution)'
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'
        msbuildArgs: '/p:RunAnalyzers=true'
        vsVersion: $(vsVersion)

    - task: DownloadPipelineArtifact@2
      displayName: 'Download coverage report'
      inputs:
        artifact: DotNetCoverage
        targetPath: 'coverage'

    - task: DownloadPipelineArtifact@2
      displayName: 'Download test results'
      inputs:
        artifact: DotNetTestResults
        targetPath: 'TestResults'

    - powershell: |
        # Coverage is computed in another job and can have a different base path.
        # We need to normalize content of the coverage files to the current VM job path.
        # Values generated by the agent can look like this:
        #   `C:\sonar-ci\_work\1\s`
        #   `C:\sonar-ci\_work\2\s`
        $CurrentPath = ${env:BUILD_SOURCESDIRECTORY}
        $Pattern = [Regex]::Escape($CurrentPath) -Replace "\\\\\d+\\\\","\\\d+\\" # We replace the existing escaped "\\1\\" digit(s) with actual pattern to search for any other digit(s)
        dir coverage.xml | % {
            $Path = $_.FullName
            Write-Host "Updating ${Path} to common root ${CurrentPath}"
            (Get-Content -Path $Path -Raw) -Replace $Pattern,$CurrentPath | Set-Content $Path
        }
      displayName: Fix coverage paths

    - task: SonarCloudAnalyze@2
      displayName: 'Code Analysis - End'

    - task: SonarCloudPublish@2
      displayName: 'Code Analysis - Publish QG'
      inputs:
        pollingTimeoutSec: '300'

  - job: buildJava
    displayName: 'Java Build, UTs and Analysis'
    workspace:
      clean: all
    steps:
    - task: DownloadSecureFile@1
      displayName: 'Download Maven settings'
      name: mavenSettings
      inputs:
        secureFile: 'maven-settings.xml'

    - template: set-azp-variables-steps.yml@pipelines-yaml-templates

    - powershell: .\scripts\set-version.ps1 -Version $(SHORT_VERSION) -BuildNumber $(Build.BuildId) -Branch $(Build.SourceBranchName) -Sha1 $(Build.SourceVersion)
      displayName: "Set Version"

    - task: DownloadPipelineArtifact@2
      displayName: 'Download .NET binaries for Maven build'
      inputs:
        artifact: Binaries
        targetPath: 'analyzers/packaging/binaries/'

    - task: SonarCloudPrepare@2
      displayName: 'Prepare code analysis for Java plugin'
      inputs:
        SonarCloud: 'SonarCloud'
        organization: 'sonarsource'
        scannerMode: 'Other'

    - task: Maven@3
      displayName: 'Maven build'
      inputs:
        goals: 'verify'
        options: -B --settings $(mavenSettings.secureFilePath) -Pcoverage -Dsonar.projectVersion=$(SHORT_VERSION)
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        testRunTitle: '$(Agent.JobName)'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.17'
        mavenOptions: $(MAVEN_OPTS)
        sonarQubeRunAnalysis: true
        sqMavenPluginVersionChoice: 'latest'

    - task: CopyFiles@2
      displayName: "Copy C# Jars to publish directory"
      inputs:
        Contents: '*.jar'
        SourceFolder: 'sonar-csharp-plugin/target'
        TargetFolder: 'plugin-jars/sonar-csharp-plugin'

    - task: CopyFiles@2
      displayName: "Copy VB.NET Jars to publish directory"
      inputs:
        Contents: '*.jar'
        SourceFolder: 'sonar-vbnet-plugin/target'
        TargetFolder: 'plugin-jars/sonar-vbnet-plugin'

    - publish: plugin-jars
      artifact: plugin-jars
      displayName: "Publish Jars"

    - task: SonarCloudPublish@2
      displayName: 'Code Analysis - Publish QG'
      inputs:
        pollingTimeoutSec: '300'
